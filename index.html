<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Giardino delle Voci ‚Äî Zero‚ÄëApp (PoC)</title>
  <style>
    :root{
      --bg:#faf8f5; --ink:#1f2937; --muted:#6b7280; --surface:#fff;
      --ok:#3a9159; --warn:#e2a21a; --accent:#4f8a8b; --accent2:#a7727d;
      --shadow:0 10px 30px rgba(0,0,0,.08); --r:16px;
    }
    html,body{height:100%;}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);}
    .wrap{max-width:1100px;margin:0 auto;padding:24px;}
    header{display:grid;grid-template-columns:1fr auto;gap:14px;align-items:end;margin-bottom:14px;}
    h1{margin:0;font-size:26px;}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35;}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .badge{display:inline-flex;gap:8px;align-items:center;background:#eef6f6;color:#155;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;}
    .card{background:var(--surface);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;}
    @media (min-width:980px){.grid{grid-template-columns:1.2fr .8fr;}}

    .panel{padding:16px;}
    .videoShell{position:relative;background:#000;border-radius:14px;overflow:hidden;aspect-ratio:16/10;}
    video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000;}

    .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;background:var(--ink);color:#fff;box-shadow:var(--shadow);}
    button.secondary{background:var(--accent);} 
    button.ok{background:var(--ok);} 
    button.warn{background:var(--warn);color:#232323;} 
    button.ghost{background:#eef1f3;color:#24313f;} 
    button:disabled{opacity:.55;cursor:not-allowed;}

    .bins{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px;}
    @media (min-width:720px){.bins{grid-template-columns:repeat(4,1fr);}}
    .bin{background:#f4f6f8;border-radius:14px;padding:12px;display:grid;gap:8px;}
    .bin h4{margin:0;font-size:14px;}
    .bin small{color:var(--muted);} 

    .kpi{display:grid;grid-template-columns:auto 1fr auto;gap:8px 12px;align-items:center;margin-top:12px;}
    .meter{height:8px;background:#e9edf0;border-radius:999px;overflow:hidden;}
    .meter i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .2s ease;}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#ecf0f3;font-size:12px;}

    .hint{color:var(--muted);font-size:12px;margin:0 0 10px;line-height:1.35;}
    label{font-size:12px;color:var(--muted);font-weight:800;display:block;margin-bottom:6px;}
    input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;font-size:12px;}
    .log{background:#0f141a;color:#d9e2ea;border-radius:12px;padding:12px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;height:210px;overflow:auto;}
    footer{margin-top:16px;color:var(--muted);font-size:12px;}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Giardino delle Voci ‚Äî Zero‚ÄëApp (PoC)</h1>
        <p class="sub">Camera iOS‚Äësafe + modello pre‚Äëaddestrato (Teachable Machine / TensorFlow.js) + voce sintetica. Nessuna app nativa. Il modello ML viene caricato <b>solo</b> quando premi ‚ÄúCarica modello‚Äù, cos√¨ un eventuale blocco CDN non impedisce l‚Äôavvio camera.</p>
      </div>
      <div class="row">
        <span class="badge" id="versionBadge">üßæ v0.9.5</span>
        <span class="badge">üé• Camera <b id="camState">non attiva</b></span>
        <span class="badge">ü§ñ Modello <b id="mlState">non caricato</b></span>
        <span class="badge">üß† Stato <b id="runState">idle</b></span>
      </div>
    </header>

    <section class="grid">
      <div class="card panel">
        <div class="videoShell">
          <video id="video" playsinline muted></video>
        </div>

        <div class="toolbar">
          <button id="startBtn" class="ok">Avvia fotocamera</button>
          <button id="stopCamBtn" class="warn" disabled>Ferma camera</button>
          <button id="loadBtn" class="ghost" disabled>Carica modello</button>
          <button id="runBtn" disabled>Riconoscimento continuo</button>
          <button id="stopBtn" class="warn" disabled>Ferma</button>
          <button id="voiceBtn" class="secondary">Test voce</button>
        </div>

        <div class="bins">
          <div class="bin"><h4>üåø Lina (Foglia)</h4><small>Label modello: <b>Lina</b></small></div>
          <div class="bin"><h4>üíß Nuna (Goccia)</h4><small>Label modello: <b>Nuna</b></small></div>
          <div class="bin"><h4>ü™® Timo (Sasso)</h4><small>Label modello: <b>Timo</b></small></div>
          <div class="bin"><h4>üå± Sofi (Radice)</h4><small>Label modello: <b>Sofi</b></small></div>
        </div>

        <div class="kpi">
          <strong style="font-size:13px;">Confidenza</strong>
          <div class="meter"><i id="meter"></i></div>
          <span id="conf" class="pill">0%</span>
        </div>
      </div>

      <div class="card panel">
        <p class="hint"><b>Passi:</b> (1) Avvia fotocamera ‚Ä¢ (2) incolla <code>‚Ä¶/model.json</code> ‚Ä¢ (3) Carica modello ‚Ä¢ (4) Riconoscimento continuo. Le classi nel modello devono chiamarsi <b>Lina</b>, <b>Nuna</b>, <b>Timo</b>, <b>Sofi</b>.</p>

        <label for="modelUrl">MODEL_URL (model.json)</label>
        <input id="modelUrl" placeholder="https://teachablemachine.withgoogle.com/models/XXXX/model.json" />

        <div style="margin-top:12px;">
          <strong style="font-size:13px;">Log</strong>
          <div id="log" class="log" aria-live="polite"></div>
        </div>

        <div style="margin-top:12px;">
          <strong style="font-size:13px;">Fallback</strong>
          <div class="toolbar">
            <button class="ghost quick" data-label="Lina">Parla: Lina</button>
            <button class="ghost quick" data-label="Nuna">Parla: Nuna</button>
            <button class="ghost quick" data-label="Timo">Parla: Timo</button>
            <button class="ghost quick" data-label="Sofi">Parla: Sofi</button>
          </div>
        </div>
      </div>
    </section>

    <footer>
      PoC: riconoscimento in-browser + TTS locale. Per produzione: contenuti UE, voci premium, e PWA con caching offline.
    </footer>
  </div>

  <script>
    // -----------------------------
    // Robust logging (avoid ‚Äúsilent‚Äù failures)
    // -----------------------------
    const logEl = document.getElementById('log');
    function log(msg){
      const t = new Date().toLocaleTimeString();
      logEl.innerHTML = `[${t}] ${msg}<br>` + logEl.innerHTML;
    }
    window.addEventListener('error', (e) => {
      try{ log(`üí• JS error: ${e.message || 'unknown'}`); }catch{}
    });
    window.addEventListener('unhandledrejection', (e) => {
      try{ log(`üí• Promise rejection: ${e.reason?.message || e.reason || 'unknown'}`); }catch{}
    });

    // -----------------------------
    // UI refs
    // -----------------------------
    const video = document.getElementById('video');
    const meter = document.getElementById('meter');
    const confEl = document.getElementById('conf');
    const camState = document.getElementById('camState');
    const mlState = document.getElementById('mlState');
    const runState = document.getElementById('runState');

    const startBtn = document.getElementById('startBtn');
    const stopCamBtn = document.getElementById('stopCamBtn');
    const loadBtn = document.getElementById('loadBtn');
    const runBtn = document.getElementById('runBtn');
    const stopBtn = document.getElementById('stopBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const modelUrlInput = document.getElementById('modelUrl');

    // -----------------------------
    // Characters
    // -----------------------------
    const CLASSES = {
      Lina: { icon:'üåø', name:'Lina', script:[
        'Ciao, sono Lina la Foglia. Oggi ho danzato con il vento.',
        'Se chiudi gli occhi, senti il fruscio degli alberi?' ] },
      Nuna: { icon:'üíß', name:'Nuna', script:[
        'Io sono Nuna, una goccia in viaggio. Ti va di ascoltare il mio canto?',
        'Quando piove, ogni pozzanghera √® uno specchio di cielo.' ] },
      Timo: { icon:'ü™®', name:'Timo', script:[
        'Sono Timo, un sasso paziente. Rimani qui con me per un respiro.',
        'Le storie pi√π lunghe hanno passi piccolissimi.' ] },
      Sofi: { icon:'üå±', name:'Sofi', script:[
        'Io sono Sofi, una radice che ascolta. Cosa vuoi coltivare oggi?',
        'Le radici parlano piano, ma ricordano tutto.' ] },
    };
    const CLASS_KEYS = Object.keys(CLASSES);

    // -----------------------------
    // Runtime state
    // -----------------------------
    let stream = null;
    let classifier = null;
    let recognizing = false;
    let synthLock = false;
    let lastSpokenLabel = null;
    let lastSpokenAt = 0;

    // -----------------------------
    // ML libraries (load on demand)
    // -----------------------------
    let libsReady = false;
    const TFJS_URLS = [
      'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js',
      'https://unpkg.com/@tensorflow/tfjs@4.20.0/dist/tf.min.js'
    ];
    // ml5 is sometimes blocked on cdnjs; provide multiple mirrors (and allow a local copy).
    const ML5_URLS = [
      './vendor/ml5.min.js',
      'https://unpkg.com/ml5@0.12.2/dist/ml5.min.js',
      'https://cdn.jsdelivr.net/npm/ml5@0.12.2/dist/ml5.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/ml5/0.12.2/ml5.min.js'
    ];

    function loadScriptOnce(src){
      return new Promise((resolve, reject) => {
        // Treat already-loaded scripts as present even if the browser rewrites the URL.
        const already = [...document.scripts].some(s => (s.src || '').includes(src.replace('./','')) || (s.src || '') === src);
        if(already){ resolve(); return; }
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.crossOrigin = 'anonymous';
        s.referrerPolicy = 'no-referrer';
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed to load ' + src));
        document.head.appendChild(s);
      });
    }

    async function tryLoadAny(urls, label){
      for(const u of urls){
        try{
          log(`‚Ä¶ provo ${label}: ${u}`);
          await loadScriptOnce(u);
          return u;
        }catch(e){
          log(`‚Ä¶ fallito ${label}: ${u}`);
        }
      }
      throw new Error(label + ' all sources failed');
    }

    async function ensureMlLibs(){
      if(libsReady) return true;
      setBadge(runState, 'loading libs');
      log('üì¶ Caricamento librerie ML (tfjs + ml5)‚Ä¶');
      try{
        // tfjs
        await tryLoadAny(TFJS_URLS, 'tfjs');
        log(`‚Ä¶ tfjs ${(typeof window.tf !== 'undefined') ? 'OK' : 'MISSING'}`);

        // ml5
        await tryLoadAny(ML5_URLS, 'ml5');
        log(`‚Ä¶ ml5 ${(typeof window.ml5 !== 'undefined') ? 'OK' : 'MISSING'}`);

        libsReady = (typeof window.tf !== 'undefined') && (typeof window.ml5 !== 'undefined');
        if(!libsReady) throw new Error('tfjs/ml5 missing after load');
        return true;
      }catch(e){
        libsReady = false;
        log(`‚ùå Impossibile caricare le librerie ML. Dettaglio: ${e.message}`);
        log('Suggerimento: se sei su GitHub Pages, puoi caricare ml5 localmente in /vendor/ml5.min.js (vedi istruzioni).');
        return false;
      }
    }

    // -----------------------------
    // Helpers
    // -----------------------------
    function setBadge(el, text){ el.textContent = text; }
    function updateMeter(p){
      const pct = Math.max(0, Math.min(1, p));
      meter.style.width = (pct*100).toFixed(0) + '%';
      confEl.textContent = (pct*100).toFixed(0) + '%';
    }
    function normalizeLabel(raw){
      const s = String(raw || '').trim();
      let best = s;
      for(const k of CLASS_KEYS){
        if(s.toLowerCase().includes(k.toLowerCase())) best = k;
      }
      return best;
    }

    // -----------------------------
    // Camera (iOS-safe)
    // -----------------------------
    async function startCamera(){
      setBadge(runState, 'starting');
      log('üé• Richiesta accesso camera‚Ä¶');

      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        camState.textContent = 'non supportata';
        setBadge(runState, 'blocked');
        log('‚ùå getUserMedia non supportato in questo browser/contesto.');
        return;
      }

      try{
        // iOS-safe: simplest constraint
        stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
        video.srcObject = stream;
        await video.play();

        camState.textContent = 'attiva';
        setBadge(runState, 'camera ok');
        log('‚úÖ Camera attiva.');

        stopCamBtn.disabled = false;
        loadBtn.disabled = false;
      }catch(err){
        camState.textContent = 'errore';
        setBadge(runState, 'blocked');
        log(`‚ùå Errore camera: ${err.name}${err.message ? ' ‚Äî ' + err.message : ''}`);
        console.error(err);
      }
    }

    function stopCamera(){
      stopRecognition();
      if(stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
      camState.textContent = 'non attiva';
      setBadge(runState, 'idle');
      log('üõë Camera fermata.');
      stopCamBtn.disabled = true;
      // keep loadBtn enabled only if you want to allow model load without camera; we keep it disabled.
      loadBtn.disabled = true;
      runBtn.disabled = true;
    }

    // -----------------------------
    // Model loading
    // -----------------------------
    async function loadModel(){
      if(!stream){ log('‚ö†Ô∏è Avvia prima la camera.'); return; }

      let url = (modelUrlInput.value || '').trim();
      if(!url){ log('‚ö†Ô∏è Inserisci il MODEL_URL.'); return; }
      if(url.endsWith('/')) url = url.slice(0,-1);
      if(!url.endsWith('model.json')) url = url + '/model.json';
      if(!url.startsWith('https://')){ log('‚ö†Ô∏è Il MODEL_URL deve iniziare con https://'); return; }

      const okLibs = await ensureMlLibs();
      if(!okLibs){
        mlState.textContent = 'errore';
        setBadge(runState, 'error');
        return;
      }

      mlState.textContent = 'verifica‚Ä¶';
      setBadge(runState, 'checking');
      log('üîé Verifica model.json‚Ä¶');

      // Fetch-check before initializing ml5 (better error messages)
      try{
        const res = await fetch(url, { method:'GET', cache:'no-store' });
        if(!res.ok){
          mlState.textContent = 'errore';
          setBadge(runState, 'error');
          log(`‚ùå model.json non raggiungibile (HTTP ${res.status}).`);
          log('Suggerimento: apri l‚ÄôURL in un tab: deve mostrarti JSON.');
          return;
        }
        const js = await res.json();
        if(!(js.modelTopology || js.weightsManifest)){
          mlState.textContent = 'errore';
          setBadge(runState, 'error');
          log('‚ùå Questo JSON non sembra un modello TensorFlow.js (mancano modelTopology/weightsManifest).');
          log('Ri‚Äëesporta da Teachable Machine: Export ‚Üí TensorFlow.js (Image Project).');
          return;
        }
      }catch(e){
        mlState.textContent = 'errore';
        setBadge(runState, 'error');
        log(`‚ùå Impossibile scaricare/parsare model.json (rete/CORS). Dettaglio: ${e.message}`);
        return;
      }

      mlState.textContent = 'caricamento‚Ä¶';
      setBadge(runState, 'loading');
      log('ü§ñ Inizializzazione modello (ml5.imageClassifier)‚Ä¶');

      try{
        // Use ml5 on the existing video element
        classifier = window.ml5.imageClassifier(url, video, () => {
          mlState.textContent = 'pronto';
          setBadge(runState, 'ready');
          log('‚úÖ Modello caricato.');
          runBtn.disabled = false;
        });
      }catch(err){
        mlState.textContent = 'errore';
        setBadge(runState, 'error');
        log(`‚ùå Errore inizializzazione: ${err?.name || 'Error'} ‚Äî ${err?.message || String(err)}`);
        if(err?.stack) log('‚Ü≥ ' + String(err.stack).split('\n')[0]);
        console.error(err);
      }
    }

    // -----------------------------
    // Recognition loop
    // -----------------------------
    function startRecognition(){
      if(!classifier){ log('‚ö†Ô∏è Carica prima il modello.'); return; }
      recognizing = true;
      runBtn.disabled = true;
      stopBtn.disabled = false;
      setBadge(runState, 'running');
      log('üß≠ Riconoscimento avviato.');
      loopClassify();
    }

    function stopRecognition(){
      recognizing = false;
      stopBtn.disabled = true;
      runBtn.disabled = (classifier == null);
      if(stream) setBadge(runState, classifier ? 'ready' : 'camera ok');
      updateMeter(0);
    }

    function loopClassify(){
      if(!recognizing || !classifier) return;
      classifier.classify((err, results) => {
        if(err){
          console.error(err);
          requestAnimationFrame(loopClassify);
          return;
        }
        const top = (results && results[0]) ? results[0] : null;
        if(!top){ requestAnimationFrame(loopClassify); return; }

        const conf = (top.confidence != null) ? top.confidence : (top.probability || 0);
        const label = normalizeLabel(top.label);
        updateMeter(conf);

        const now = Date.now();
        const minGapMs = 2800;
        const isNew = (label !== lastSpokenLabel) || (now - lastSpokenAt > 12000);

        if(conf >= 0.85 && CLASSES[label] && isNew && (now - lastSpokenAt > minGapMs)){
          speakOnce(label, conf);
          lastSpokenLabel = label;
          lastSpokenAt = now;
        }

        requestAnimationFrame(loopClassify);
      });
    }

    // -----------------------------
    // Speech
    // -----------------------------
    function speak(text){
      if(!('speechSynthesis' in window)){
        log('üîà Sintesi vocale non supportata.');
        return;
      }
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'it-IT';
      u.rate = 0.95;
      u.pitch = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

    function speakOnce(label, conf){
      if(synthLock) return;
      const c = CLASSES[label];
      const line = c.script[Math.floor(Math.random()*c.script.length)];
      log(`${c.icon} <${c.name}> (${(conf*100).toFixed(0)}%): ${line}`);
      speak(`${c.name} dice: ${line}`);
      synthLock = true;
      setTimeout(() => { synthLock = false; }, 2400);
    }

    function testVoice(){
      speak('Ciao. Questa √® una prova voce del Giardino delle Voci.');
      log('üîä Test voce eseguito.');
    }

    // -----------------------------
    // Self-check (light)
    // -----------------------------
    function selfCheck(){
      log(`üß™ Self-check: secureContext=${window.isSecureContext} | mediaDevices=${!!navigator.mediaDevices} | speech=${'speechSynthesis' in window}`);
      if(!window.isSecureContext){
        log('‚ö†Ô∏è Contesto non sicuro: su iOS la camera richiede HTTPS.');
      }
    }

    // -----------------------------
    // Wiring
    // -----------------------------
    startBtn.addEventListener('click', startCamera);
    stopCamBtn.addEventListener('click', stopCamera);
    loadBtn.addEventListener('click', loadModel);
    runBtn.addEventListener('click', startRecognition);
    stopBtn.addEventListener('click', () => { stopRecognition(); log('üõë Riconoscimento fermato.'); });
    voiceBtn.addEventListener('click', testVoice);

    document.querySelectorAll('.quick').forEach(btn => {
      btn.addEventListener('click', () => speakOnce(btn.dataset.label, 1));
    });

    // Boot
    const RELEASE = '0.9.5';
    const BUILD_TIME = new Date().toISOString();
    const vb = document.getElementById('versionBadge');
    if(vb){ vb.textContent = `üßæ v${RELEASE}`; vb.title = `Build ${BUILD_TIME}`; }

    selfCheck();
    log('‚úÖ Pagina pronta. 1) Avvia fotocamera  2) Incolla MODEL_URL  3) Carica modello  4) Riconoscimento continuo');
  </script>
</body>
</html>
